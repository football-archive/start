---
import BaseLayout from "../../../layouts/BaseLayout.astro";

import { loadClubSquads, sortClubRoster } from "../../../lib/clubSquads";
import { loadClubMaster } from "../../../lib/clubMaster";
import { loadLeagueMaster } from "../../../lib/leagueMaster";

import { loadCallups } from "../../../lib/callups";
import { buildRepLabelFromCallups } from "../../../lib/repCandidate";

import RosterView from "../../../components/RosterView.astro";

import { buildClubColumns } from "../../../lib/rosterColumns";
import { toYMD } from "../../../lib/rosterFormat";

// ★ URLヘルパー
import { clubsListUrl } from "../../../lib/urls";

import { buildRepHistoryLinksFromCallups } from "../../../lib/repCandidate";

// --------------------
// getStaticPaths：keyで生成
// --------------------
export async function getStaticPaths() {
  const rows = loadClubSquads();
  const keys = new Set(rows.map((r) => `${r.league_key}|||${r.club_key}`));

  return [...keys].map((k) => {
    const [league_key, club_key] = k.split("|||");
    return { params: { league_key, club_key } }; // ★encodeしない
  });
}

const league_key = Astro.params.league_key!;
const club_key = Astro.params.club_key!;

// --------------------
// master 参照：表示名（日本語）をここで確定
// --------------------
const clubMaster = loadClubMaster();
const leagueMaster = loadLeagueMaster();

const clubInfo = clubMaster.find((c) => c.club_key === club_key);
const leagueInfo = leagueMaster.find((l) => l.league_key === league_key);

const clubInMaster = !!clubInfo;
const leagueInMaster = !!leagueInfo;

const clubLabel = clubInfo?.club_display_ja ?? club_key;
const leagueLabel = leagueInfo?.league_display_ja ?? league_key;

// --------------------
// roster：keyで抽出（window/snapshot/season を扱う）
// --------------------
const allRows = loadClubSquads().filter(
  (r) => r.league_key === league_key && r.club_key === club_key,
);

// window 正規化（想定外は summer 扱いで落ちないようにする）
const normWindow = (v) => {
  const s = String(v ?? "")
    .trim()
    .toLowerCase();
  return s === "winter" ? "winter" : "summer";
};

// season の “新しさ” 比較用（"2025-26" → 2025）
const seasonStart = (seasonStr) => {
  const s = String(seasonStr ?? "").trim();
  const m = s.match(/^(\d{4})/);
  return m ? Number(m[1]) : 0;
};

// snapshot の max（window内で最新1枚を作る）
const maxSnapIn = (rows) => {
  let max = "";
  for (const r of rows) {
    const s = toYMD(String(r.snapshot_date ?? ""));
    if (s && s > max) max = s;
  }
  return max;
};

// ---- season：候補（全件）＋URL選択 ----
// URL（静的HTMLでも JS 側は location を見るが、初期値用にここでも読む）
const url = new URL(Astro.request.url);
const qWin = String(url.searchParams.get("window") ?? "").toLowerCase();
const qSeason = String(url.searchParams.get("season") ?? "").trim();

// season候補（全シーズン）
const seasonCandidates = Array.from(
  new Set(allRows.map((r) => String(r.season ?? "").trim()).filter(Boolean)),
).sort((a, b) => seasonStart(b) - seasonStart(a));

// 「最新season」= ピル初期表示に使う（静的HTMLの初期表示）
const latestSeason = seasonCandidates[0] ?? "";

// seasonごとに summer/winter の「最新スナップ」だけ残してロスター化
type SeasonPack = {
  season: string;
  hasSummer: boolean;
  hasWinter: boolean;
  defaultWindow: "summer" | "winter";
  summerUpdated: string;
  winterUpdated: string;
  rosterSummer: any[];
  rosterWinter: any[];
  starRowsSummer: any[];
  starRowsWinter: any[];
  isLatestViewSummer: boolean;
  isLatestViewWinter: boolean;
};

const seasonPacks: SeasonPack[] = seasonCandidates.map((s) => {
  const rowsForSeason = allRows.filter(
    (r) => String(r.season ?? "").trim() === s,
  );

  const summerRows = rowsForSeason.filter(
    (r) => normWindow(r.window) === "summer",
  );
  const winterRows = rowsForSeason.filter(
    (r) => normWindow(r.window) === "winter",
  );

  const summerSnapMax = maxSnapIn(summerRows);
  const winterSnapMax = maxSnapIn(winterRows);

  const rosterSummer = sortClubRoster(
    summerRows.filter(
      (r) => toYMD(String(r.snapshot_date ?? "")) === summerSnapMax,
    ),
  );
  const rosterWinter = sortClubRoster(
    winterRows.filter(
      (r) => toYMD(String(r.snapshot_date ?? "")) === winterSnapMax,
    ),
  );

  const hasSummer = rosterSummer.length > 0;
  const hasWinter = rosterWinter.length > 0;

  // デフォルト window：winter 優先（そのseason内で）
  const defaultWindow: "summer" | "winter" = hasWinter ? "winter" : "summer";

  // そのseasonの「最新view」判定（年齢など）
  const latestWindow = defaultWindow;
  const isLatestViewSummer = latestWindow === "summer" && hasSummer;
  const isLatestViewWinter = latestWindow === "winter" && hasWinter;

  const summerUpdated = summerSnapMax ? toYMD(summerSnapMax) : "";
  const winterUpdated = winterSnapMax ? toYMD(winterSnapMax) : "";

  const starRowsSummer = rosterSummer
    .filter((r) => String((r as any).is_star ?? "").trim() === "1")
    .slice(0, 3);

  const starRowsWinter = rosterWinter
    .filter((r) => String((r as any).is_star ?? "").trim() === "1")
    .slice(0, 3);

  return {
    season: s,
    hasSummer,
    hasWinter,
    defaultWindow,
    summerUpdated,
    winterUpdated,
    rosterSummer,
    rosterWinter,
    starRowsSummer,
    starRowsWinter,
    isLatestViewSummer,
    isLatestViewWinter,
  };
});

// 全体としてロスターがあるか
const hasRoster = seasonPacks.some((p) => p.hasSummer || p.hasWinter);

// 静的HTMLの初期表示 season/window（JSが上書きするが初期描画に使う）
const initialSeason =
  qSeason && seasonCandidates.includes(qSeason) ? qSeason : latestSeason;
const initialPack = seasonPacks.find((p) => p.season === initialSeason);

const defaultWindow = initialPack?.defaultWindow ?? "summer";

const initialWindow =
  qWin === "winter" || qWin === "summer" ? (qWin as any) : defaultWindow;

// 現行の title/heading 用（静的HTML上は latestSeason を表示）
const season = initialSeason;

// ===== title =====
const pageTitleBase = season
  ? `${clubLabel}｜${leagueLabel}（${season}）`
  : `${clubLabel}｜${leagueLabel}`;

const title = `${pageTitleBase} 登録メンバー一覧（スカッド）`;

// heading（H1表示）… 以前の h1 と同じ文言
const heading = `${clubLabel} 登録メンバー一覧（スカッド）${season ? `（${season}）` : ""}`;

// ===== 代表（候補）表示：WC2026の最新スナップショットだけを参照 =====
const callups = loadCallups();
const {
  repLabel,
  repLinks,
  maxSnapshot: repMaxSnapshot,
} = buildRepLabelFromCallups(callups, { competition: "WC", edition: 2026 });

const repHistoryLinks = buildRepHistoryLinksFromCallups(callups, {
  competition: "WC",
  excludeEdition: 2026, // WC2026 は既に下段で出てるので除外
  max: 6,
});

const columnsBySeason: Record<string, { summer: any; winter: any }> = {};
for (const p of seasonPacks) {
  columnsBySeason[p.season] = {
    summer: buildClubColumns({
      isLatestView: p.isLatestViewSummer,
      repLabel,
      repLinks,
      repHistoryLinks,
      showStats: false,
    }),
    winter: buildClubColumns({
      isLatestView: p.isLatestViewWinter,
      repLabel,
      repLinks,
      repHistoryLinks,
      showStats: false,
    }),
  };
}

// pills 用：公開対象リーグのみ + sort_rank順
const leaguePills = leagueMaster
  .filter((l: any) => (l.is_public ?? true) === true)
  .filter((l) => (l.league_key ?? "").trim().length > 0)
  .map((l: any) => {
    const n = Number(String(l.sort_rank ?? "").trim());
    const sort_rank = Number.isFinite(n) ? n : 999;

    return {
      key: l.league_key,
      label: l.league_display_ja || l.league_key,
      sort_rank,
    };
  })
  .sort((a, b) => {
    if (a.sort_rank !== b.sort_rank) return a.sort_rank - b.sort_rank;
    return a.label.localeCompare(b.label, "ja");
  });

// 検索テキスト共通
const searchTextFn = (r) =>
  `${r.name_ja ?? ""} ${r.name_en ?? ""} ${repLabel(r) ?? ""} ${r.nationality ?? ""}`.trim();
---

<BaseLayout
  title={title}
  description={title}
  bodyClass="page-club"
  bodyStyle="margin:0; font-family: system-ui;"
  showPageHeader={true}
  crumbs={[
    { label: "トップ", href: "/" },
    { label: "クラブ", href: "/clubs" },
    { label: leagueLabel, href: clubsListUrl({ leagueKey: league_key }) },
    { label: clubLabel },
  ]}
  heading={heading}
>
  {
    /* ✅ H1直下に「リーグピル＋同リーグ一覧＋全リーグ」を配置（共通化の流れ） */
  }
  <div slot="under-title" class="pills" style="margin: 10px 0 14px;">
    {
      leaguePills.map((p) => (
        <a
          class={`pill ${p.key === league_key ? "is-active" : ""}`}
          href={clubsListUrl({ leagueKey: p.key })}
        >
          <span class="dot" aria-hidden="true" />
          {p.label}
        </a>
      ))
    }

    <a class="pill" href={clubsListUrl({ leagueKey: league_key })}>
      <span class="dot" aria-hidden="true"></span>同リーグのクラブ一覧
    </a>

    <a class="pill" href="/clubs">
      <span class="dot" aria-hidden="true"></span>全リーグ
    </a>
  </div>

  {/* ✅ season pills（JSで切替） */}
  {
    seasonCandidates.length > 0 ? (
      <div
        class="pills season-toggle"
        style="margin: 0 0 14px;"
        data-default-season={initialSeason}
      >
        {seasonCandidates.map((s) => {
          const active = s === initialSeason;
          return (
            <button
              type="button"
              class={`pill ${active ? "is-active" : ""}`}
              data-season={s}
            >
              {s}
            </button>
          );
        })}
      </div>
    ) : null
  }

  {
    seasonPacks.map((p) => (
      <>
        <section
          class="star-section"
          data-season={p.season}
          data-star-window="summer"
          style={`display:${p.season === initialSeason && initialWindow === "summer" ? "" : "none"}`}
          aria-label={`注目選手（夏 ${p.season}）`}
        >
          <h2 class="star-title">⭐ 注目選手</h2>
          {p.starRowsSummer.length > 0 ? (
            <div class="star-grid">
              {p.starRowsSummer.map((r) => (
                <div class="star-card">
                  <div class="star-name">
                    {r.name_ja || r.name_en || r.name}
                    <span class="star-pos">
                      （{r.position_primary || r.position}）
                    </span>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="star-empty">準備中</div>
          )}
        </section>

        <section
          class="star-section"
          data-season={p.season}
          data-star-window="winter"
          style={`display:${p.season === initialSeason && initialWindow === "winter" ? "" : "none"}`}
          aria-label={`注目選手（冬 ${p.season}）`}
        >
          <h2 class="star-title">⭐ 注目選手</h2>
          {p.starRowsWinter.length > 0 ? (
            <div class="star-grid">
              {p.starRowsWinter.map((r) => (
                <div class="star-card">
                  <div class="star-name">
                    {r.name_ja || r.name_en || r.name}
                    <span class="star-pos">
                      （{r.position_primary || r.position}）
                    </span>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="star-empty">準備中</div>
          )}
        </section>
      </>
    ))
  }

  {/* ここは BaseLayout が page-wrap を持つので <main padding:16px> は不要 */}
  <div class="meta-top">
    <div class="meta-line">
      <span class="meta-item">
        クラブスカッド更新日：
        {
          seasonPacks.map((p) => (
            <>
              <span
                class="updated-date"
                data-season={p.season}
                data-updated="summer"
                style={`display:${p.season === initialSeason && initialWindow === "summer" ? "" : "none"}`}
              >
                {p.summerUpdated || "—"}
              </span>
              <span
                class="updated-date"
                data-season={p.season}
                data-updated="winter"
                style={`display:${p.season === initialSeason && initialWindow === "winter" ? "" : "none"}`}
              >
                {p.winterUpdated || "—"}
              </span>
            </>
          ))
        }
      </span>
      <span class="meta-sep">／</span>
      <span class="meta-item">
        代表招集更新日：
        <span class="updated-date">{toYMD(repMaxSnapshot) || "—"}</span>
      </span>
    </div>

    {/* summer / winter toggle */}
    <div
      class="window-toggle"
      data-default={defaultWindow}
      data-season-packs={JSON.stringify(
        seasonPacks.map((p) => ({
          season: p.season,
          hasSummer: p.hasSummer,
          hasWinter: p.hasWinter,
          defaultWindow: p.defaultWindow,
        })),
      )}
    >
      <button
        type="button"
        class={`wt-btn ${initialWindow === "summer" ? "is-active" : ""}`}
        data-window="summer"
        disabled={!initialPack?.hasSummer}
        title={!initialPack?.hasSummer ? "データなし" : ""}
      >
        夏（summer）
      </button>

      <button
        type="button"
        class={`wt-btn ${initialWindow === "winter" ? "is-active" : ""}`}
        data-window="winter"
        disabled={!initialPack?.hasWinter}
        title={!initialPack?.hasWinter ? "データなし" : ""}
      >
        冬（winter）
      </button>
      <span class="wt-hint">※ 表示切替（シーズン前半 / 後半）</span>
    </div>
    {
      !clubInMaster || !leagueInMaster || !hasRoster ? (
        <div class="empty">
          <h2>データが見つかりません</h2>
          <p>
            {!leagueInMaster
              ? "リーグが辞書に未登録です。"
              : !clubInMaster
                ? "クラブが辞書に未登録です。"
                : "指定されたクラブのデータがありません。"}
          </p>
          <div class="empty-actions">
            <a class="btn" href="/clubs">
              クラブ一覧へ戻る
            </a>
          </div>
        </div>
      ) : (
        <>
          {seasonPacks.map((p) => (
            <>
              <section
                data-season={p.season}
                data-window="summer"
                style={`display:${p.season === initialSeason && initialWindow === "summer" ? "" : "none"}`}
              >
                <RosterView
                  tableId={`club-roster-${p.season}-summer`}
                  rows={p.rosterSummer}
                  minWidthPx={920}
                  borderColor="var(--border, #e6e6e6)"
                  placeholder="検索：選手名 / 国名 / 国籍"
                  searchText={searchTextFn}
                  columns={columnsBySeason[p.season].summer}
                />
              </section>

              <section
                data-season={p.season}
                data-window="winter"
                style={`display:${p.season === initialSeason && initialWindow === "winter" ? "" : "none"}`}
              >
                <RosterView
                  tableId={`club-roster-${p.season}-winter`}
                  rows={p.rosterWinter}
                  minWidthPx={920}
                  borderColor="var(--border, #e6e6e6)"
                  placeholder="検索：選手名 / 国名 / 国籍"
                  searchText={searchTextFn}
                  columns={columnsBySeason[p.season].winter}
                />
              </section>
            </>
          ))}
        </>
      )
    }

    <script is:inline>
      window.addEventListener("DOMContentLoaded", () => {
        try {
          const seasonRoot = document.querySelector(".season-toggle");
          const windowRoot = document.querySelector(".window-toggle");
          if (!windowRoot) return;

          const windowBtns = Array.from(
            windowRoot.querySelectorAll("button[data-window]"),
          );
          const seasonBtns = seasonRoot
            ? Array.from(seasonRoot.querySelectorAll("button[data-season]"))
            : [];

          const sections = Array.from(
            document.querySelectorAll("section[data-window][data-season]"),
          );
          const updatedDates = Array.from(
            document.querySelectorAll("[data-updated][data-season]"),
          );
          const starSections = Array.from(
            document.querySelectorAll("[data-star-window][data-season]"),
          );

          const packs = JSON.parse(
            windowRoot.getAttribute("data-season-packs") || "[]",
          ); // [{season,hasSummer,hasWinter,defaultWindow},...]

          const params = new URLSearchParams(location.search);
          const qWin = (params.get("window") || "").toLowerCase();
          const qSeason = (params.get("season") || "").trim();

          const defaultSeason =
            seasonRoot?.getAttribute("data-default-season") ||
            packs[0]?.season ||
            "";
          const initialSeason =
            qSeason && packs.some((p) => p.season === qSeason)
              ? qSeason
              : defaultSeason;

          function findPack(season) {
            return packs.find((p) => p.season === season);
          }

          function setWindowAvailability(season) {
            const p = findPack(season);
            const hasSummer = !!p?.hasSummer;
            const hasWinter = !!p?.hasWinter;

            windowBtns.forEach((b) => {
              const w = b.getAttribute("data-window");
              if (w === "summer") b.disabled = !hasSummer;
              if (w === "winter") b.disabled = !hasWinter;
              b.title = b.disabled ? "データなし" : "";
            });

            return p?.defaultWindow || "summer";
          }

          function setActive(season, win) {
            // sections
            sections.forEach((sec) => {
              const s = sec.getAttribute("data-season");
              const w = sec.getAttribute("data-window");
              sec.style.display = s === season && w === win ? "" : "none";
            });

            // updated dates
            updatedDates.forEach((el) => {
              const s = el.getAttribute("data-season");
              const w = el.getAttribute("data-updated");
              el.style.display = s === season && w === win ? "" : "none";
            });

            // star sections
            starSections.forEach((sec) => {
              const s = sec.getAttribute("data-season");
              const w = sec.getAttribute("data-star-window");
              sec.style.display = s === season && w === win ? "" : "none";
            });

            // active window button
            windowBtns.forEach((b) => {
              b.classList.toggle(
                "is-active",
                b.getAttribute("data-window") === win,
              );
            });

            // active season button
            seasonBtns.forEach((b) => {
              b.classList.toggle(
                "is-active",
                b.getAttribute("data-season") === season,
              );
            });

            // update query (without reload)
            const u = new URL(location.href);
            u.searchParams.set("season", season);
            u.searchParams.set("window", win);
            history.replaceState(null, "", u.toString());
          }

          // init
          const defaultWinFromSeason = setWindowAvailability(initialSeason);
          const initialWin =
            qWin === "winter" || qWin === "summer"
              ? qWin
              : defaultWinFromSeason;
          setActive(initialSeason, initialWin);

          // bind window clicks
          windowBtns.forEach((b) => {
            b.addEventListener("click", () => {
              if (b.disabled) return;
              const win = b.getAttribute("data-window");
              if (!win) return;
              const curSeason = (
                new URLSearchParams(location.search).get("season") ||
                initialSeason
              ).trim();
              setActive(curSeason, win);
            });
          });

          // bind season clicks
          seasonBtns.forEach((b) => {
            b.addEventListener("click", () => {
              const season = b.getAttribute("data-season");
              if (!season) return;

              const defaultWin = setWindowAvailability(season);
              const curWin = (
                new URLSearchParams(location.search).get("window") || ""
              ).toLowerCase();
              const win =
                curWin === "winter" || curWin === "summer"
                  ? curWin
                  : defaultWin;

              // disabledなら season側デフォルトに寄せる
              const p = findPack(season);
              const hasSummer = !!p?.hasSummer;
              const hasWinter = !!p?.hasWinter;
              const finalWin =
                win === "winter" && !hasWinter
                  ? "summer"
                  : win === "summer" && !hasSummer
                    ? "winter"
                    : win;

              setActive(season, finalWin);
            });
          });
        } catch (e) {
          console.error("season/window toggle init failed:", e);
        }
      });
    </script>

    <style is:global>
      .page-club .meta-top {
        margin: 6px 0 12px;
      }

      .page-club .meta-line {
        font-size: 12px;
        opacity: 0.78;
        margin-bottom: 8px;
      }
      .page-club .meta-item {
        display: inline-block;
      }
      .page-club .meta-sep {
        margin: 0 6px;
        opacity: 0.6;
      }
      .page-club .updated-date {
        font-weight: 700;
      }

      .page-club .window-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0 6px;
        flex-wrap: wrap;
      }

      .page-club .wt-btn {
        appearance: none;
        border: 1px solid var(--border, #e6e6e6);
        background: #f3f4f6; /* ← グレー */
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
        transition:
          transform 0.06s ease,
          box-shadow 0.06s ease;
      }
      /* hover */
      .page-club .wt-btn:hover:not(:disabled) {
        background: #e5e7eb;
      }

      .page-club .wt-btn.is-active {
        font-weight: 700; /* 強すぎない */
        background: #111;
        color: #fff;
        border-color: #111;
        cursor: pointer; /* ← 押せる印象を明確に */
      }
      .page-club .wt-btn:disabled {
        opacity: 0.35;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .page-club .wt-hint {
        font-size: 12px;
        opacity: 0.6;
        margin-left: 6px;
        color: #6b7280;
      }

      @media (max-width: 640px) {
        .page-club .wt-hint {
          width: 100%;
          margin-left: 0;
        }
      }

      /* ===== 注目選手（クラブ）：代表と同じトーンに統一 ===== */
      .star-section {
        margin: 12px 0 16px;
        padding: 10px 12px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        background: #f3e5f5;
      }

      .star-title {
        margin: 0 0 8px;
        font-size: 13px;
        font-weight: 650;
        opacity: 1;
      }

      .star-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(3, 1fr);
      }

      @media (max-width: 900px) {
        .star-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 640px) {
        .star-grid {
          grid-template-columns: 1fr;
        }
      }

      .star-card {
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 10px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
      }

      .star-name {
        font-weight: 600;
        font-size: 13px;
        line-height: 1.35;
        word-break: keep-all;
      }

      .star-pos {
        font-weight: 500;
        font-size: 12px;
        opacity: 0.7;
        margin-left: 4px;
      }

      .star-empty {
        font-size: 13px;
        opacity: 0.65;
        padding: 8px 4px;
      }

      .rep2-links--past {
        margin-top: 2px;
        opacity: 0.75;
        font-size: 11px;
      }
      .rep2-ed--past {
        text-decoration: underline;
      }

      .rep2-ed--latest {
        font-weight: 700;
        text-decoration-thickness: 2px;
      }

      .rep2-sep {
        opacity: 0.55;
      }

      .rep2-ed:not(.rep2-ed--latest) {
        opacity: 0.8;
      }
    </style>
  </div>
</BaseLayout>
