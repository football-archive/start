---
// src/pages/wc/[year]/index.astro
import BaseLayout from "../../../layouts/BaseLayout.astro";

import { loadCallups, countrySlug } from "../../../lib/callups";
import { tournamentTopUrl } from "../../../lib/urls";
import { loadGroups, getGroupsList } from "../../../lib/tournamentGroups";

import MatchScheduleTable from "../../../components/MatchScheduleTable.astro";
import {
  loadCompetitionSchedule,
  filterMatches,
  mdNum,
} from "../../../lib/competitionSchedule";

import {
  getGoalRanking,
  getAssistRanking,
  addRank,
} from "../../../lib/matchEvents";

import { getAwards } from "../../../lib/competitionAwards";

// --------------------
// getStaticPathsï¼šcallups ã«å­˜åœ¨ã™ã‚‹ edition ã‚’è‡ªå‹•åˆ—æŒ™
// --------------------
export async function getStaticPaths() {
  const rows = loadCallups();
  const years = new Set(
    rows
      .filter((r: any) => String(r.competition ?? "") === "WC")
      .map((r: any) => String(r.edition ?? "").trim())
      .filter(Boolean),
  );

  return [...years].map((year) => ({ params: { year } }));
}

const year = String(Astro.params.year ?? "").trim();

const goalRank = addRank(getGoalRanking("WC", String(year)), "goals");
const assistRank = addRank(getAssistRanking("WC", String(year)), "assists");

const all = loadCompetitionSchedule();
const matches = filterMatches(all, "WC", String(year)).sort(
  (a, b) => mdNum(a.md) - mdNum(b.md),
);

// URLs
const topHref = tournamentTopUrl({ tournament: "wc", year });

// team å´ã® getStaticPaths ã¨ã€ŒåŒã˜ slugã€
const teamHref = (country: string) => `${topHref}/team/${countrySlug(country)}`;

// ----- callups -----
const rows = loadCallups();
const filtered = (rows as any[]).filter(
  (r) => r.competition === "WC" && String(r.edition) === String(year),
);

// ===== çŠ¶æ…‹åˆ¥ã‚»ãƒƒãƒˆ =====
const statusMap = {
  qualified: new Set<string>(),
  playoff: new Set<string>(),
  eliminated: new Set<string>(),
};

for (const r of filtered) {
  const b = String(r.confederation_bucket ?? "").toUpperCase();

  if (!b || b === "QUALIFIED")
    statusMap.qualified.add(String(r.country ?? "").trim());
  else if (b.includes("PO"))
    statusMap.playoff.add(String(r.country ?? "").trim());
  else if (b.includes("ELIM"))
    statusMap.eliminated.add(String(r.country ?? "").trim());
}

// confederation -> countries
const map = new Map<string, string[]>();

for (const r of filtered) {
  const country = String(r.country ?? "").trim();
  if (!country) continue;

  const conf = String(r.confederation ?? "").trim() || "OTHER";
  if (!map.has(conf)) map.set(conf, []);
  const list = map.get(conf)!;
  if (!list.includes(country)) list.push(country);
}

// è¡¨ç¤ºé †
const confOrder = [
  "AFC",
  "CAF",
  "CONCACAF",
  "CONMEBOL",
  "OFC",
  "UEFA",
  "OTHER",
];
const confs = [...map.keys()].sort((a, b) => {
  const ia = confOrder.indexOf(a);
  const ib = confOrder.indexOf(b);
  return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
});

// ===== ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ã«å›½ã‚’ã¾ã¨ã‚ã¦3åˆ†é¡ =====
const allCountries: { country: string; conf: string }[] = [];
for (const conf of confs) {
  const countries = map.get(conf) ?? [];
  for (const country of countries) allCountries.push({ country, conf });
}

const qualifiedCountries = allCountries.filter(({ country }) =>
  statusMap.qualified.has(country),
);
const playoffCountries = allCountries.filter(({ country }) =>
  statusMap.playoff.has(country),
);
const eliminatedCountries = allCountries.filter(({ country }) =>
  statusMap.eliminated.has(country),
);

// ===== ã‚°ãƒ«ãƒ¼ãƒ— =====
const groupRows = loadGroups("WC", String(year));
const groups = getGroupsList(groupRows);

// groupSets: group -> [{name, slug, is_placeholder}]
const groupSets: Record<
  string,
  { name: string; slug: string; is_placeholder: boolean }[]
> = {};
for (const r of (groupRows as any[]) || []) {
  const g = String(r.group ?? "").trim();
  if (!g) continue;

  const name = String((r.country_name_ja || r.country_key || "") ?? "").trim();
  if (!name) continue;

  const is_placeholder = String(r.is_placeholder ?? "0") === "1";
  const rawForSlug = String(
    (r.route_param || r.country_key || name) ?? "",
  ).trim();
  const slug = countrySlug(rawForSlug || name);

  if (!groupSets[g]) groupSets[g] = [];
  groupSets[g].push({ name, slug, is_placeholder });
}

// countryName(æ—¥æœ¬èª) -> group letter
const countryToGroup = new Map<string, string>();
for (const g of groups) {
  const items = groupSets[g] || [];
  for (const it of items) {
    if (it.is_placeholder) continue;
    const name = String(it.name ?? "").trim();
    if (!name) continue;
    countryToGroup.set(name, String(g).trim());
  }
}

// ===== é †ä½è¡¨ï¼ˆgroups_masteræ‹¡å¼µç‰ˆï¼‰=====
const standingsByGroup = new Map<string, any[]>();
for (const r of (groupRows as any[]) || []) {
  const g = String(r.group ?? "").trim();
  if (!g) continue;

  if (!standingsByGroup.has(g)) standingsByGroup.set(g, []);
  standingsByGroup.get(g)!.push(r);
}

// ä¸¦ã³é †ï¼šrankãŒã‚ã‚Œã°rankã€ãªã‘ã‚Œã°slot
for (const [g, list] of standingsByGroup.entries()) {
  list.sort((a, b) => {
    const ra = Number(a.rank ?? 0);
    const rb = Number(b.rank ?? 0);
    if (ra && rb) return ra - rb;
    return Number(a.slot ?? 999) - Number(b.slot ?? 999);
  });
}

const awardGroups = getAwards("WC", String(year));

const wcTitle = `FIFAãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—${year}ï¼ˆWC${year} / World Cup ${year}ï¼‰`;
const pageTitle = `${wcTitle}ï½œå‡ºå ´å›½ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»æ—¥ç¨‹ãƒ»å¾—ç‚¹ãƒ©ãƒ³ã‚­ãƒ³ã‚°`;
const pageDesc = `${wcTitle}ã®å‡ºå ´å›½ãƒ»ä»£è¡¨ãƒ¡ãƒ³ãƒãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€è©¦åˆæ—¥ç¨‹ã€å¾—ç‚¹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¸€è¦§ã§ãã¾ã™ã€‚`;
---

<BaseLayout
  title={pageTitle}
  description={pageDesc}
  bodyClass="page-nt"
  bodyStyle="margin:0; font-family: system-ui;"
  showPageHeader={true}
  crumbs={[{ label: "ãƒˆãƒƒãƒ—", href: "/" }, { label: wcTitle }]}
  heading={wcTitle}
>
  <style is:global>
    .page-nt .quick-title {
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--muted, #666);
    }

    .page-nt h2,
    .page-nt h3 {
      color: #3b82f6;
    }

    .page-nt section a {
      color: #2563eb;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .page-nt section a:hover {
      color: #1d4ed8;
      background: #eef6fd;
    }

    /* pills */
    .page-nt .pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .page-nt .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border, #e6e6e6);
      background: #fff;
      color: #111;
      text-decoration: none;
      font-size: 13px;
      line-height: 1;
      transition:
        transform 0.06s ease,
        box-shadow 0.06s ease;
      user-select: none;
    }
    .page-nt .pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      background: #eef6fd;
    }
    .page-nt .pill .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #2b6cb0;
      opacity: 0.6;
    }
    /* âœ… active pill: ç™½èƒŒæ™¯ã®ã¾ã¾å¼·èª¿ï¼ˆè¦‹ãˆãªããªã‚‰ãªã„ï¼‰ */
    .page-nt .pill.is-active {
      background: #fff;
      color: #111;
      border-color: #111;
      font-weight: 800;
    }
    .page-nt .pill.is-active .dot {
      opacity: 1;
    }
    .page-nt .pill.clear {
      background: #f3f4f6;
      border-style: dashed;
    }
    /* clearï¼ˆå…¨ã€œï¼‰ãŒ active ã«ãªã£ã¦ã‚‚è¦–èªæ€§ã‚­ãƒ¼ãƒ— */
    .page-nt .pill.clear.is-active {
      background: #f3f4f6;
      color: #111;
      border-color: #111;
    }

    /* filterbar */
    .page-nt .filterbar {
      margin: 10px 0 12px;
      padding: 12px;
      border: 1px solid var(--border, #e6e6e6);
      border-radius: 14px;
      background: #fff;
    }
    .page-nt .filterbar .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .page-nt .filterbar .count {
      font-size: 13px;
      color: var(--muted, #666);
      white-space: nowrap;
    }
    .page-nt .filterbar input[type="search"] {
      width: min(420px, 100%);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border, #e6e6e6);
      font-size: 14px;
      outline: none;
    }
    .page-nt .filterbar input[type="search"]:focus {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.35);
    }
    .page-nt .filterbar .subttl {
      margin: 10px 0 8px;
      font-size: 13px;
      color: var(--muted, #666);
    }

    /* team cards */
    .page-nt .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 10px;
    }
    .page-nt .team-card {
      display: block;
      border: 1px solid var(--border, #e6e6e6);
      border-radius: 14px;
      background: #fff;
      padding: 10px 12px;
      text-decoration: none;
      color: #111;
      transition:
        transform 0.06s ease,
        box-shadow 0.06s ease;
    }
    .page-nt .team-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
      background: #eef6fd;
    }
    .page-nt .team-card .row1 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .page-nt .team-card .name {
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    /* âœ… status dot (ç¢ºå®Ÿã«è¦‹ãˆã‚‹ç‰ˆ) */
    .page-nt .status-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      display: inline-block;
      flex: 0 0 auto;
      background: #999; /* fallback */
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1) inset;
      margin-top: 1px;
    }
    .page-nt .status-dot.q {
      background: #22c55e;
    }
    .page-nt .status-dot.p {
      background: #f59e0b;
    }
    .page-nt .status-dot.e {
      background: #ef4444;
    }

    .page-nt .team-card .name {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .page-nt .team-card .meta {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted, #666);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .page-nt .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border, #e6e6e6);
      font-size: 12px;
      background: #fff;
      white-space: nowrap;
      color: #111;
      text-decoration: none;
    }

    /* group grid */
    .page-nt .group-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin: 10px 0 18px;
    }
    .page-nt .group-card {
      border: 1px solid var(--border, #e6e6e6);
      border-radius: 14px;
      background: #fff;
      padding: 12px;
    }
    .page-nt .group-card h3 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #3b82f6;
    }
    .page-nt .group-card ul {
      margin: 0;
      padding-left: 18px;
      line-height: 1.7;
    }
    .page-nt .group-card .placeholder {
      color: #666;
    }

    .page-nt .mini-standings {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    .page-nt .mini-standings th,
    .page-nt .mini-standings td {
      border-top: 1px solid var(--border, #e6e6e6);
      padding: 6px 6px;
      text-align: center;
      white-space: nowrap;
    }
    .page-nt .mini-standings th:first-child,
    .page-nt .mini-standings td:first-child {
      text-align: left;
    }
    .page-nt .mini-standings thead th {
      color: #3b82f6;
      font-weight: 800;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‰æãŒå®‰å…¨ */
    /* ===== scheduleï¼ˆè©¦åˆæ—¥ç¨‹ï¼‰ ===== */

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ ï¼ˆã“ã“ãŒ scroll container ã«ãªã‚‹ã®ã§ sticky ãŒå®‰å®šï¼‰ */
    .page-nt .matches-wrap {
      overflow: auto;
      border: 1px solid var(--border, #e6e6e6);
      border-radius: 14px;
      background: #fff;
      max-height: 560px; /* å¥½ã¿ã§èª¿æ•´ã€‚ãƒšãƒ¼ã‚¸å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ã—ãŸã„ãªã‚‰å‰Šé™¤ */
    }

    /* sticky ãŒå´©ã‚Œã‚„ã™ã„ç’°å¢ƒå‘ã‘ï¼ˆcollapseã‚’é¿ã‘ã‚‹ï¼‰ */
    .page-nt .matches-wrap table.schedule {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    /* ã“ã‚ŒãŒãªã„ã¨ã€Œè©°ã¾ã£ã¦è¦‹ãˆã‚‹ã€ã€Œè¡¨ã£ã½ããªã„ã€ã«ãªã‚ŠãŒã¡ */
    .page-nt .matches-wrap table.schedule th,
    .page-nt .matches-wrap table.schedule td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border, #e6e6e6);
      font-size: 13px;
      white-space: nowrap;
      vertical-align: middle;
    }

    /* ãƒ˜ãƒƒãƒ€å›ºå®š */
    .page-nt .matches-wrap table.schedule thead th {
      position: sticky;
      top: 0;
      z-index: 5;
      background: #f8fafc;
      border-bottom: 1px solid var(--border, #e6e6e6);
    }

    /* zebraï¼ˆä»»æ„ï¼šè¦‹ã‚„ã™ã•UPã€‚ä¸è¦ãªã‚‰æ¶ˆã—ã¦OKï¼‰ */
    .page-nt .matches-wrap table.schedule tbody tr:nth-child(even) td {
      background: #fcfcfd;
    }

    /* å¯¾æˆ¦è¡¨ç¤ºï¼ˆã‚ãªãŸã® â€œhome / vs / awayâ€ ç‰ˆã®ã¾ã¾ï¼‰ */
    .page-nt .matches-wrap td.col-match {
      display: grid;
      grid-template-columns: 1fr 34px 1fr;
      align-items: center;
      gap: 6px;
    }
    .page-nt .matches-wrap td.col-match .team.home {
      text-align: right;
      font-weight: 700;
    }
    .page-nt .matches-wrap td.col-match .vs {
      text-align: center;
      color: var(--muted, #666);
      font-size: 12px;
    }
    .page-nt .matches-wrap td.col-match .team.away {
      text-align: left;
      font-weight: 700;
    }

    .page-nt td.col-match {
      white-space: nowrap;
    }

    .page-nt td.col-match {
      display: grid;
      grid-template-columns: 1fr 34px 1fr; /* çœŸã‚“ä¸­ã‚’å›ºå®šå¹…ã« */
      align-items: center;
      gap: 6px;
    }

    .page-nt td.col-match .team.home {
      text-align: right;
      font-weight: 700;
    }

    .page-nt td.col-match .vs {
      text-align: center;
      color: var(--muted, #666);
      font-size: 12px;
    }

    .page-nt td.col-match .team.away {
      text-align: left;
      font-weight: 700;
    }

    .page-nt .rank-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
      margin: 10px 0 18px;
    }
    .page-nt .rank-card {
      border: 1px solid var(--border, #e6e6e6);
      border-radius: 14px;
      background: #fff;
      padding: 12px;
    }
    .page-nt .rank-card h3 {
      margin: 0 0 8px;
      font-size: 16px;
      color: #3b82f6;
    }
    .page-nt table.rank {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .page-nt table.rank th,
    .page-nt table.rank td {
      border-top: 1px solid var(--border, #e6e6e6);
      padding: 8px 8px;
      text-align: left;
      white-space: nowrap;
    }
    .page-nt table.rank thead th {
      color: #3b82f6;
      font-weight: 800;
    }
    .page-nt table.rank td.num,
    .page-nt table.rank th.num {
      text-align: right;
    }
    .page-nt table.rank td.rank,
    .page-nt table.rank th.rank {
      width: 54px;
      text-align: center;
    }
    .page-nt .rank-muted {
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted, #666);
    }

    /* ã‚°ãƒ«ãƒ¼ãƒ—å‹æ•—è¡¨ã®å›½åãƒªãƒ³ã‚¯ã ã‘é»’ã« */
    .page-nt .mini-standings td:first-child a {
      color: #111;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .page-nt .mini-standings td:first-child a:hover {
      color: #000;
      background: #f3f4f6;
    }

    /* ã‚°ãƒ«ãƒ¼ãƒ—ã‚«ãƒ¼ãƒ‰å†…ã®å›½åãƒªãƒ³ã‚¯ã‚‚é»’ã« */
    .page-nt .group-card ul a {
      color: #111;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .page-nt .group-card ul a:hover {
      color: #000;
      background: #f3f4f6;
    }

    .group-standings-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .group-standings {
      min-width: 520px; /* ã“ã‚ŒãŒé‡è¦ï¼šåˆ—ãŒæ½°ã‚Œãªã„æœ€ä½å¹… */
      border-collapse: collapse;
    }

    .group-standings th,
    .group-standings td {
      white-space: nowrap; /* æ•°å­—åˆ—ã‚’æŠ˜ã‚Šè¿”ã•ãªã„ */
    }
  </style>

  <p class="quick-title" style="margin: 6px 0 10px;">
    FIFAãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—ï¼ˆWorld Cup / WCï¼‰{year} ã®å‡ºå ´å›½ãƒ»ä»£è¡¨ãƒ¡ãƒ³ãƒãƒ¼ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€è©¦åˆæ—¥ç¨‹ã€å¾—ç‚¹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¸€è¦§ã§ãã¾ã™ã€‚ã€‚
  </p>
  {
    /* =========================
      (1) ã‚°ãƒ«ãƒ¼ãƒ—æ ï¼ˆAã€œLï¼‰
     ========================= */
  }
  <section id="groups" style="margin: 18px 0;">
    <h2>ã‚°ãƒ«ãƒ¼ãƒ—å‹æ•—è¡¨ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰</h2>
    <p class="quick-title" style="margin: 6px 0 10px;">
      å„ã‚°ãƒ«ãƒ¼ãƒ—ã®å‚åŠ å›½ï¼ˆâ€»ãƒ—ãƒ¬ãƒ¼ã‚ªãƒ•æ ã¯ç¢ºå®šå¾Œã«ãƒªãƒ³ã‚¯åŒ–ï¼‰
    </p>

    <div class="group-grid">
      {
        groups.map((g) => (
          <div class="group-card">
            <h3>Group {g}</h3>
            <ul>
              {(groupSets[g] || []).map((it) => (
                <li>
                  {it.is_placeholder ? (
                    <span class="placeholder">{it.name}</span>
                  ) : (
                    <a
                      href={`${topHref}/team/${it.slug}?from=group-card-${encodeURIComponent(
                        g,
                      )}&anchor=groups`}
                    >
                      {it.name}
                    </a>
                  )}
                </li>
              ))}
            </ul>

            {(() => {
              const s = standingsByGroup.get(g) || [];
              if (s.length === 0) return null;

              const v = (x: any) =>
                String(x ?? "").trim() ? String(x).trim() : "-";
              const isPH = (r: any) => String(r.is_placeholder ?? "0") === "1";

              return (
                <div class="group-standings-wrap">
                  <table
                    class="mini-standings"
                    aria-label={`Group ${g} standings`}
                  >
                    <thead>
                      <tr>
                        <th>å›½</th>
                        <th>è©¦</th>
                        <th>å‹</th>
                        <th>åˆ†</th>
                        <th>è² </th>
                        <th>å¾—</th>
                        <th>å¤±</th>
                        <th>å·®</th>
                        <th>ç‚¹</th>
                      </tr>
                    </thead>
                    <tbody>
                      {s.map((r: any) => (
                        <tr>
                          <td>
                            {isPH(r) ? (
                              <span class="placeholder">
                                {r.country_name_ja}
                              </span>
                            ) : (
                              <a
                                href={`${topHref}/team/${countrySlug(
                                  r.route_param ||
                                    r.country_key ||
                                    r.country_name_ja,
                                )}`}
                              >
                                {r.country_name_ja}
                              </a>
                            )}
                          </td>
                          <td>{v(r.played)}</td>
                          <td>{v(r.w)}</td>
                          <td>{v(r.d)}</td>
                          <td>{v(r.l)}</td>
                          <td>{v(r.gf)}</td>
                          <td>{v(r.ga)}</td>
                          <td>{v(r.gd)}</td>
                          <td>
                            <b>{v(r.pts)}</b>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              );
            })()}

            <p class="quick-title" style="margin: 10px 0 0;">
              <a href={`${topHref}?group=${encodeURIComponent(g)}#teams`}>
                ã‚°ãƒ«ãƒ¼ãƒ—{g}ã®å›½ã‚’çµã‚Šè¾¼ã‚€ â†’
              </a>
            </p>
          </div>
        ))
      }
    </div>
  </section>

  {
    /* =========================
      (2) å‡ºå ´å›½ã‚«ãƒ¼ãƒ‰ï¼šæ¤œç´¢/ãƒ”ãƒ«çµã‚Šè¾¼ã¿ï¼ˆè»½é‡ãƒãƒƒã‚¸ç‰ˆï¼‰
     ========================= */
  }
  <section id="teams" style="margin: 18px 0;">
    <h2>å‡ºå ´å›½ãƒ»ä»£è¡¨ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h2>
    <p class="quick-title" style="margin: 6px 0 10px;">
      å¤§é™¸ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»çŠ¶æ…‹ã§çµã‚Šè¾¼ã¿ï¼å›½åæ¤œç´¢ãŒã§ãã¾ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å„å›½ä»£è¡¨ãƒšãƒ¼ã‚¸ã¸ï¼‰
    </p>

    <div class="filterbar" id="teams-filterbar">
      <div class="row">
        <input
          id="teams-q"
          type="search"
          placeholder="å›½åã§æ¤œç´¢ï¼ˆä¾‹ï¼šæ—¥æœ¬ / Argentinaï¼‰"
          autocomplete="off"
          spellcheck={false}
        />
        <div class="count">
          è¡¨ç¤ºï¼š<b id="teams-count">0</b> / <span id="teams-total">0</span>
        </div>
      </div>

      <div class="subttl">å¤§é™¸ã§çµã‚Šè¾¼ã¿</div>
      <div class="pills" id="teams-conf-pills">
        <a class="pill clear" href={`${topHref}#teams`} data-teams-conf=""
          ><span class="dot" aria-hidden="true"></span>å…¨å¤§é™¸</a
        >
        <a
          class="pill"
          href={`${topHref}?continent=UEFA#teams`}
          data-teams-conf="UEFA"
          ><span class="dot" aria-hidden="true"></span>UEFA(æ¬§å·)</a
        >
        <a
          class="pill"
          href={`${topHref}?continent=CONMEBOL#teams`}
          data-teams-conf="CONMEBOL"
          ><span class="dot" aria-hidden="true"></span>CONMEBOL(å—ç±³)</a
        >
        <a
          class="pill"
          href={`${topHref}?continent=CONCACAF#teams`}
          data-teams-conf="CONCACAF"
          ><span class="dot" aria-hidden="true"></span>CONCACAF(åŒ—ä¸­ç±³ãƒ»ã‚«ãƒªãƒ–æµ·)</a
        >
        <a
          class="pill"
          href={`${topHref}?continent=AFC#teams`}
          data-teams-conf="AFC"
          ><span class="dot" aria-hidden="true"></span>AFC(ã‚¢ã‚¸ã‚¢)</a
        >
        <a
          class="pill"
          href={`${topHref}?continent=CAF#teams`}
          data-teams-conf="CAF"
          ><span class="dot" aria-hidden="true"></span>CAF(ã‚¢ãƒ•ãƒªã‚«)</a
        >
        <a
          class="pill"
          href={`${topHref}?continent=OFC#teams`}
          data-teams-conf="OFC"
          ><span class="dot" aria-hidden="true"></span>OFC(ã‚ªã‚»ã‚¢ãƒ‹ã‚¢)</a
        >
      </div>

      <div class="subttl">ã‚°ãƒ«ãƒ¼ãƒ—ã§çµã‚Šè¾¼ã¿</div>
      <div class="pills" id="teams-group-pills">
        <a class="pill clear" href={`${topHref}#teams`} data-teams-group=""
          ><span class="dot" aria-hidden="true"></span>å…¨ã‚°ãƒ«ãƒ¼ãƒ—</a
        >
        {
          groups.map((g) => (
            <a
              class="pill"
              href={`${topHref}?group=${encodeURIComponent(g)}#teams`}
              data-teams-group={String(g).trim()}
            >
              <span class="dot" aria-hidden="true" />
              Group {g}
            </a>
          ))
        }
      </div>

      <div class="subttl">çŠ¶æ…‹ï¼ˆå‡ºå ´ / PO / æ•—é€€ï¼‰</div>
      <div class="pills" id="teams-status-pills">
        <a class="pill clear" href={`${topHref}#teams`} data-teams-status=""
          ><span class="dot" aria-hidden="true"></span>å…¨éƒ¨</a
        >
        <a class="pill" href={`${topHref}?status=q#teams`} data-teams-status="q"
          ><span class="dot" aria-hidden="true"></span>ğŸŸ¢ å‡ºå ´</a
        >
        <a class="pill" href={`${topHref}?status=p#teams`} data-teams-status="p"
          ><span class="dot" aria-hidden="true"></span>ğŸŸ¡ PO</a
        >
        <a class="pill" href={`${topHref}?status=e#teams`} data-teams-status="e"
          ><span class="dot" aria-hidden="true"></span>ğŸ”´ æ•—é€€</a
        >
      </div>
    </div>

    <div class="team-grid" id="teams-grid">
      {
        qualifiedCountries.map(({ country, conf }) => {
          const g = countryToGroup.get(String(country ?? "").trim()) ?? "";
          return (
            <a
              class="team-card"
              data-team-card
              data-country={country}
              data-conf={conf}
              data-group={g}
              data-status="q"
              href={`${teamHref(country)}?from=teams-card&anchor=teams`}
            >
              <div class="row1">
                <div class="name">
                  <span class="status-dot q" aria-hidden="true" />
                  {country}
                </div>
              </div>
              <div class="meta">
                <span class="badge">{conf}</span>
                {g ? <span class="badge">Group {g}</span> : null}
              </div>
            </a>
          );
        })
      }

      {
        playoffCountries.map(({ country, conf }) => {
          const g = countryToGroup.get(String(country ?? "").trim()) ?? "";
          return (
            <a
              class="team-card"
              data-team-card
              data-country={country}
              data-conf={conf}
              data-group={g}
              data-status="p"
              href={`${teamHref(country)}?from=po-card&anchor=teams`}
            >
              <div class="row1">
                <div class="name">
                  <span class="status-dot p" aria-hidden="true" />
                  {country}
                </div>
              </div>
              <div class="meta">
                <span class="badge">{conf}</span>
                {g ? <span class="badge">Group {g}</span> : null}
              </div>
            </a>
          );
        })
      }

      {
        eliminatedCountries.map(({ country, conf }) => {
          const g = countryToGroup.get(String(country ?? "").trim()) ?? "";
          return (
            <a
              class="team-card"
              data-team-card
              data-country={country}
              data-conf={conf}
              data-group={g}
              data-status="e"
              href={`${teamHref(country)}?from=elim-card&anchor=teams`}
            >
              <div class="row1">
                <div class="name">
                  <span class="status-dot e" aria-hidden="true" />
                  {country}
                </div>
              </div>
              <div class="meta">
                <span class="badge">{conf}</span>
                {g ? <span class="badge">Group {g}</span> : null}
              </div>
            </a>
          );
        })
      }
    </div>

    <p
      class="quick-title"
      id="teams-notfound"
      style="display:none; margin-top:10px;"
    >
      æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å›½ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆçµã‚Šè¾¼ã¿ã‚’è§£é™¤ã—ã¦ã¿ã¦ãã ã•ã„ï¼‰
    </p>
  </section>

  {
    /* =========================
    (3) ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå¾—ç‚¹ / ã‚¢ã‚·ã‚¹ãƒˆï¼‰
   ========================= */
  }
  <section id="rankings" style="margin: 18px 0;">
    <h2>å¾—ç‚¹ãƒ»ã‚¢ã‚·ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
    <p class="quick-title" style="margin: 6px 0 10px;">
      è©¦åˆçµæœãƒ»å¾—ç‚¹ãƒ»ã‚¢ã‚·ã‚¹ãƒˆã‹ã‚‰è‡ªå‹•é›†è¨ˆã—ã¦ã„ã¾ã™ã€‚
    </p>

    <div class="rank-grid">
      <div class="rank-card">
        <h3>ğŸ¥‡ å¾—ç‚¹ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        {
          goalRank.length === 0 ? (
            <p class="rank-muted">ã¾ã ã‚¤ãƒ™ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
          ) : (
            <table class="rank" aria-label={`WC${year} goal ranking`}>
              <thead>
                <tr>
                  <th class="rank">é †ä½</th>
                  <th>é¸æ‰‹</th>
                  <th>å›½</th>
                  <th class="num">å¾—ç‚¹</th>
                </tr>
              </thead>
              <tbody>
                {goalRank.slice(0, 30).map((r) => (
                  <tr>
                    <td class="rank">
                      <b>{r.rank}</b>
                    </td>
                    <td>{r.player}</td>
                    <td>
                      <a
                        href={`${teamHref(r.team)}?from=rank-goal&anchor=rankings`}
                      >
                        {r.team}
                      </a>
                    </td>
                    <td class="num">
                      <b>{r.goals}</b>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )
        }
      </div>

      <div class="rank-card">
        <h3>ğŸ¯ ã‚¢ã‚·ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        {
          assistRank.length === 0 ? (
            <p class="rank-muted">ã¾ã ã‚¤ãƒ™ãƒ³ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
          ) : (
            <table class="rank" aria-label={`WC${year} assist ranking`}>
              <thead>
                <tr>
                  <th class="rank">é †ä½</th>
                  <th>é¸æ‰‹</th>
                  <th>å›½</th>
                  <th class="num">ã‚¢ã‚·ã‚¹ãƒˆ</th>
                </tr>
              </thead>
              <tbody>
                {assistRank.slice(0, 30).map((r) => (
                  <tr>
                    <td class="rank">
                      <b>{r.rank}</b>
                    </td>
                    <td>{r.player}</td>
                    <td>
                      <a
                        href={`${teamHref(r.team)}?from=rank-assist&anchor=rankings`}
                      >
                        {r.team}
                      </a>
                    </td>
                    <td class="num">
                      <b>{r.assists}</b>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )
        }
      </div>
    </div>
  </section>

  {
    /* =========================
    (4) æ—¥ç¨‹ãƒ»è©¦åˆçµæœï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ç”¨ã« section wrapï¼‰
   ========================= */
  }
  <section id="schedule" style="margin: 18px 0;">
    <h2>æ—¥ç¨‹ãƒ»è©¦åˆçµæœï¼ˆãƒãƒƒãƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰</h2>
    <p class="quick-title" style="margin: 6px 0 10px;">
      å…¨104è©¦åˆã®æ—¥ç¨‹ã¯ã‚³ãƒãƒ©ã‹ã‚‰ï¼ˆçµæœã¯éšæ™‚åæ˜ ã—ã¦ã„ãã¾ã™ï¼‰
    </p>
    <MatchScheduleTable matches={matches} heading={`WC${year} æ—¥ç¨‹ãƒ»çµæœ`} />
  </section>

  {
    /* =========================
    (5) è¡¨å½°ï¼ˆãƒšãƒ¼ã‚¸æœ«å°¾ã¸ç§»å‹•ï¼‰
   ========================= */
  }
  <section id="awards" style="margin: 18px 0;">
    <h2>è¡¨å½°ï¼ˆå€‹äººè³ãƒ»ãƒ™ã‚¹ãƒˆã‚¤ãƒ¬ãƒ–ãƒ³ï¼‰</h2>
    <p class="quick-title" style="margin: 6px 0 10px;">
      å¤§ä¼šå…¬å¼ã®å€‹äººè³ãƒ»ãƒ™ã‚¹ãƒˆã‚¤ãƒ¬ãƒ–ãƒ³ã‚’æ²è¼‰
    </p>

    {
      awardGroups.length === 0 ? (
        <p class="rank-muted">ã¾ã è¡¨å½°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      ) : (
        <div class="rank-grid">
          {awardGroups.map((g) => (
            <div class="rank-card">
              <h3>ğŸ… {g.name}</h3>
              <ul style="margin:0; padding-left:18px; line-height:1.7;">
                {g.items.map((r) => {
                  const rankLabel =
                    g.key === "golden_ball"
                      ? r.rank === "1"
                        ? "æœ€å„ªç§€é¸æ‰‹ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ï¼‰"
                        : r.rank === "2"
                          ? "å„ªç§€é¸æ‰‹ï¼ˆã‚·ãƒ«ãƒãƒ¼ï¼‰"
                          : r.rank === "3"
                            ? "å„ªç§€é¸æ‰‹ï¼ˆãƒ–ãƒ­ãƒ³ã‚ºï¼‰"
                            : r.rank
                      : r.rank;

                  return (
                    <li>
                      <span style="color:var(--muted,#666); margin-right:6px;">
                        {rankLabel ? `${rankLabel}:` : ""}
                      </span>
                      <b>{r.player}</b>
                      {r.team ? <span>ï¼ˆ{r.team}ï¼‰</span> : null}
                      {r.note ? (
                        <span style="color:var(--muted,#666);">
                          {" "}
                          - {r.note}
                        </span>
                      ) : null}
                    </li>
                  );
                })}
              </ul>
            </div>
          ))}
        </div>
      )
    }
  </section>

  <script is:inline>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const norm = (s) => String(s ?? "").trim();
    const normLower = (s) => norm(s).toLowerCase();

    function setActivePills(containerSel, key, value) {
      $$(containerSel + " [data-" + key + "]").forEach((a) => {
        const v = a.getAttribute("data-" + key) ?? "";
        a.classList.toggle("is-active", v === (value ?? ""));
      });
    }

    function updateCounts(visible, total) {
      const elCount = $("#teams-count");
      const elTotal = $("#teams-total");
      if (elCount) elCount.textContent = String(visible);
      if (elTotal) elTotal.textContent = String(total);
    }

    function readTeamsStateFromUrl() {
      const params = new URLSearchParams(location.search);
      return {
        conf: norm(params.get("continent")), // e.g. UEFA
        group: norm(params.get("group")), // e.g. A
        status: norm(params.get("status")), // q|p|e
        q: norm($("#teams-q")?.value),
      };
    }

    function writeUrl(state) {
      const params = new URLSearchParams(location.search);

      if (state.conf) params.set("continent", state.conf);
      else params.delete("continent");

      if (state.group) params.set("group", state.group);
      else params.delete("group");

      if (state.status) params.set("status", state.status);
      else params.delete("status");

      const next = params.toString();
      const url = next ? `?${next}#teams` : `#teams`;
      history.replaceState(null, "", url);
    }

    function applyTeamsFilter(state) {
      const cards = $$("[data-team-card]");
      const total = cards.length;

      const q = normLower(state.q);
      const conf = norm(state.conf);
      const group = norm(state.group);
      const status = norm(state.status);

      let visible = 0;

      cards.forEach((card) => {
        const cName = normLower(card.getAttribute("data-country"));
        const cConf = norm(card.getAttribute("data-conf"));
        const cGroup = norm(card.getAttribute("data-group"));
        const cStatus = norm(card.getAttribute("data-status"));

        const okQ = !q || cName.includes(q);
        const okConf = !conf || cConf === conf;
        const okGroup = !group || cGroup === group;
        const okStatus = !status || cStatus === status;

        const ok = okQ && okConf && okGroup && okStatus;

        card.style.display = ok ? "" : "none";
        if (ok) visible++;
      });

      updateCounts(visible, total);

      const nf = $("#teams-notfound");
      if (nf) nf.style.display = visible === 0 ? "" : "none";

      setActivePills("#teams-conf-pills", "teams-conf", conf);
      setActivePills("#teams-group-pills", "teams-group", group);
      setActivePills("#teams-status-pills", "teams-status", status);
    }

    window.addEventListener("DOMContentLoaded", () => {
      const qInput = $("#teams-q");

      // åˆæœŸåæ˜ 
      const init = readTeamsStateFromUrl();
      applyTeamsFilter(init);

      if (qInput) {
        qInput.addEventListener("input", () => {
          const st = readTeamsStateFromUrl();
          applyTeamsFilter(st);
        });
      }

      // pills (å³æ™‚åæ˜ )
      $$("#teams-conf-pills [data-teams-conf]").forEach((a) => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const st = readTeamsStateFromUrl();
          st.conf = a.getAttribute("data-teams-conf") ?? "";
          writeUrl(st);
          applyTeamsFilter(st);
        });
      });

      $$("#teams-group-pills [data-teams-group]").forEach((a) => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const st = readTeamsStateFromUrl();
          st.group = a.getAttribute("data-teams-group") ?? "";
          writeUrl(st);
          applyTeamsFilter(st);
        });
      });

      $$("#teams-status-pills [data-teams-status]").forEach((a) => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const st = readTeamsStateFromUrl();
          st.status = a.getAttribute("data-teams-status") ?? "";
          writeUrl(st);
          applyTeamsFilter(st);
        });
      });

      window.addEventListener("popstate", () => {
        applyTeamsFilter(readTeamsStateFromUrl());
      });
    });
  </script>
</BaseLayout>
