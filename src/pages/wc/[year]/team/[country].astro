---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import RosterView from "../../../../components/RosterView.astro";

import { loadCallups, sortForRoster } from "../../../../lib/callups";
import { buildNtColumns } from "../../../../lib/rosterColumns";
import { loadClubMaster } from "../../../../lib/clubMaster";

import { loadGroups } from "../../../../lib/tournamentGroups";

// ====================
// getStaticPaths
// é‡è¦ï¼šparams.country ã¯ã€Œæœªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®å›½åã€ã‚’è¿”ã™
// ====================
export async function getStaticPaths() {
  const rows = loadCallups().filter((r) => String(r.competition) === "WC");
  const seen = new Set<string>();
  const paths: { params: { year: string; country: string } }[] = [];

  for (const r of rows as any[]) {
    const year = String(r.edition ?? "").trim();
    const country = String(r.country ?? "").trim(); // â† æœªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆæ—¥æœ¬èªï¼‰
    if (!year || !country) continue;

    const key = `${year}__${country}`;
    if (seen.has(key)) continue;
    seen.add(key);

    paths.push({ params: { year, country } });
  }

  return paths;
}

// ====================
// page data
// ====================
const { year, country } = Astro.params;

// Astro.params.country ã¯ã€Œæœªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®å›½åã€ãŒå…¥ã‚‹æƒ³å®š
const countryName = String(country ?? "").trim();

const rowsAll = loadCallups()
  .filter((r: any) => String(r.edition ?? "") === String(year))
  .filter((r: any) => String(r.country ?? "").trim() === countryName);

const groups = loadGroups("WC", String(year), "group");

// ãã®å›½ã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆgroups.csv ã‹ã‚‰æ¢ã™ï¼‰
const norm = (s: any) =>
  String(s ?? "")
    .trim()
    .replace(/ã€€/g, " ")
    .replace(/\s+/g, " ");

const group =
  groups.find((g: any) => norm(g.route_param) === norm(countryName))?.group ??
  groups.find((g: any) => norm(g.country_name_ja) === norm(countryName))
    ?.group ??
  "";

// ãã®å›½ã®å¤§é™¸ï¼ˆcallupsã®æœ€åˆã®è¡Œã‹ã‚‰å–ã‚Œã‚‹æƒ³å®šï¼‰
const continent = rowsAll[0]?.confederation ?? "";

const rows = rowsAll.sort(sortForRoster);
const starRows = rows
  .filter((r) => String((r as any).is_star ?? "").trim() === "1")
  .slice(0, 3);

// ã‚¯ãƒ©ãƒ–ãƒªãƒ³ã‚¯è§£æ±ºï¼ˆclub_master.csv ã‚’ä½¿ã†ï¼‰
const normalize = (s: string) =>
  String(s || "")
    .trim()
    .replace(/\s+/g, " ")
    .replace(/ã€€/g, " ")
    .toLowerCase();

const parseAliases = (aliases: string) =>
  String(aliases || "")
    .split(/[|,ã€/]/)
    .map((s) => s.trim())
    .filter(Boolean);

const clubMaster = loadClubMaster();

const clubHref = (clubName: string) => {
  const raw = String(clubName || "").trim();
  if (!raw) return "";

  const key = normalize(raw);

  const c = clubMaster.find((x: any) => {
    const ja = normalize(x.club_display_ja || "");
    const en = normalize(x.club_display_en || "");
    if (key === ja || key === en) return true;

    const als = parseAliases(x.aliases);
    return als.some((a) => normalize(a) === key);
  });

  return c ? `/clubs/${c.league_key}/${c.club_key}` : "";
};

const columns = buildNtColumns({
  isLatestView: true,
  showStats: false,
  clubHref,
});

const topHref = `/wc/${year}`;

// <title> ç”¨ï¼ˆå…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒšãƒ¼ã‚¸åã«ã‚‚å‡ºã‚‹ï¼‰
const title = `FIFAãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—${year}ï¼ˆWC${year}ï¼‰${countryName}ä»£è¡¨ãƒ¡ãƒ³ãƒãƒ¼`;
const description = `${countryName}ä»£è¡¨ã®æ‹›é›†ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆWC${year} / FIFAãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—${year}ï¼‰ã€‚ãƒã‚¸ã‚·ãƒ§ãƒ³ã€æ‰€å±ã‚¯ãƒ©ãƒ–ã€ä»£è¡¨ãƒ‡ãƒ“ãƒ¥ãƒ¼ã€ç”Ÿå¹´æœˆæ—¥ãªã©ã€‚`;
const heading = `${countryName}ä»£è¡¨`;
---

<BaseLayout
  title={title}
  description={description}
  bodyClass="page-nt"
  bodyStyle="margin:0; font-family: system-ui;"
  showPageHeader={true}
  crumbs={[
    { label: "ãƒˆãƒƒãƒ—", href: "/" },
    { label: `WC${year}`, href: topHref },
    { label: countryName },
  ]}
  heading={heading}
>
  {
    (continent || group) && (
      <div class="nt-nav-pills">
        {continent && (
          <a
            class="pill"
            href={`/wc/${year}?continent=${encodeURIComponent(continent)}#teams`}
          >
            ğŸŒ {continent}
          </a>
        )}
        {group && (
          <a
            class="pill"
            href={`/wc/${year}?group=${encodeURIComponent(group)}#teams`}
          >
            ğŸ”  ã‚°ãƒ«ãƒ¼ãƒ— {group}
          </a>
        )}
      </div>
    )
  }

  {/* âœ… H1ç›´ä¸‹ã« â€œæˆ»ã‚‹ãƒªãƒ³ã‚¯â€ ã‚’å¯„ã›ã‚‹ï¼ˆå…±é€šåŒ–ã®æµã‚Œï¼‰ */}
  <section class="star-section" aria-label="æ³¨ç›®é¸æ‰‹">
    <h2 class="star-title">â­ æ³¨ç›®é¸æ‰‹</h2>

    {
      starRows.length > 0 ? (
        <div class="star-grid">
          {starRows.map((r) => (
            <div class="star-card">
              <div class="star-name">
                {r.name_ja || r.name_en || r.name}
                <span class="star-pos">
                  ï¼ˆ{r.position_primary || r.position}ï¼‰
                </span>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="star-empty">æº–å‚™ä¸­</div>
      )
    }
  </section>

  <RosterView {rows} {columns} />

  <script is:inline define:vars={{ topHref }}>
    const TOP = topHref;

    function updateBackLink() {
      const a = document.getElementById("back-link-anchor");
      if (!a) return false;

      const params = new URLSearchParams(location.search);
      const from = (params.get("from") || "").trim();
      const anchor = (params.get("anchor") || "").trim();

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      let href = TOP;
      let label = "WCä¸€è¦§ã¸æˆ»ã‚‹";

      // from=group-A
      const mGroup = from.match(/^group-(.+)$/);
      if (mGroup) {
        const g = mGroup[1];
        href = `${TOP}?group=${encodeURIComponent(g)}`;
        label = `ã‚°ãƒ«ãƒ¼ãƒ—${g}ã¸æˆ»ã‚‹`;
      }

      // from=conf-UEFA
      const mConf = from.match(/^conf-(.+)$/);
      if (mConf) {
        const conf = mConf[1];
        href = `${TOP}?continent=${encodeURIComponent(conf)}`;
        label = `${conf}ã¸æˆ»ã‚‹`;
      }

      if (anchor) href = `${href}#${anchor}`;

      a.href = href;
      a.textContent = `â† ${label}`;
      return true;
    }

    function boot() {
      if (updateBackLink()) return;

      let tries = 0;
      const timer = setInterval(() => {
        tries++;
        if (updateBackLink() || tries >= 40) clearInterval(timer);
      }, 50);
    }

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", boot);
    } else {
      boot();
    }
  </script>

  {/* JSã§æ–‡è¨€å·®ã—æ›¿ãˆã‚‚ã‚ã‚‹ã®ã§ global æ¨å¥¨ */}
  <style is:global>
    .page-nt .back-link {
      margin: 0 0 10px;
      font-size: 13px;
      color: #374151;
    }
    .page-nt .back-link a {
      color: inherit;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .page-nt .back-link a:hover {
      opacity: 0.85;
    }

    .star-section {
      margin: 12px 0 16px;
      padding: 10px 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      background: #f3e5f5;
    }

    .star-title {
      margin: 0 0 8px;
      font-size: 13px; /* å°‘ã—å°ã•ã */
      font-weight: 650; /* å°‘ã—å¼±ãï¼ˆ700â†’ï¼‰ */
      opacity: 1;
    }

    .star-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(3, 1fr);
    }

    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ */
    @media (max-width: 900px) {
      .star-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ã‚¹ãƒãƒ› */
    @media (max-width: 640px) {
      .star-grid {
        grid-template-columns: 1fr;
      }
    }

    .star-card {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 10px;
      padding: 8px 10px; /* å°‘ã—è–„ã */
      display: flex;
      align-items: center;
    }

    .star-name {
      font-weight: 600; /* 700â†’600 */
      font-size: 13px; /* ã“ã“ã§ç¢ºå®Ÿã«å°ã•ã */
      line-height: 1.35;
      word-break: keep-all;
    }

    .star-pos {
      font-weight: 500;
      font-size: 12px;
      opacity: 0.7;
      margin-left: 4px;
    }

    .star-empty {
      font-size: 13px;
      opacity: 0.65;
      padding: 8px 4px;
    }

    .page-nt .star-section {
      background: #f3e5f5 !important;
      border-color: rgba(0, 0, 0, 0.08) !important;
      opacity: 1;
    }

    /* ===== ä»£è¡¨ãƒšãƒ¼ã‚¸ï¼šå¤§é™¸ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒŠãƒ“ ===== */
    .nt-nav-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 4px 0 14px;
    }
  </style>
</BaseLayout>
