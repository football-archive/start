---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import RosterView from "../../../../components/RosterView.astro";

import { loadCallups, sortForRoster } from "../../../../lib/callups";
import { buildNtColumns } from "../../../../lib/rosterColumns";
import { loadClubMaster } from "../../../../lib/clubMaster";

import { loadGroups } from "../../../../lib/tournamentGroups";
import { loadClubSquads } from "../../../../lib/clubSquads";
import { toYMD } from "../../../../lib/rosterFormat";

// ====================
// getStaticPaths
// é‡è¦ï¼šparams.country ã¯ã€Œæœªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®å›½åã€ã‚’è¿”ã™
// ====================
export async function getStaticPaths() {
  const rows = loadCallups().filter((r) => String(r.competition) === "WC");
  const seen = new Set<string>();
  const paths: { params: { year: string; country: string } }[] = [];

  for (const r of rows as any[]) {
    const year = String(r.edition ?? "").trim();
    const country = String(r.country ?? "").trim(); // â† æœªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆæ—¥æœ¬èªï¼‰
    if (!year || !country) continue;

    const key = `${year}__${country}`;
    if (seen.has(key)) continue;
    seen.add(key);

    paths.push({ params: { year, country } });
  }

  return paths;
}

// ====================
// page data
// ====================
const { year, country } = Astro.params;

// Astro.params.country ã¯ã€Œæœªã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®å›½åã€ãŒå…¥ã‚‹æƒ³å®š
const countryName = String(country ?? "").trim();

const rowsAll = loadCallups()
  .filter((r: any) => String(r.edition ?? "") === String(year))
  .filter((r: any) => String(r.country ?? "").trim() === countryName);

// æ›´æ–°æ—¥ï¼ˆãã®å›½Ã—ãã®å¹´ ã® callups ã®æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
const maxSnapshot = (() => {
  let max = "";
  for (const r of rowsAll as any[]) {
    const s = toYMD(String((r as any).snapshot_date ?? ""));
    if (s && s > max) max = s;
  }
  return max;
})();

// ãã®å›½ãŒå‡ºå ´ã—ãŸWCã®å¹´ï¼ˆcallupsã«å­˜åœ¨ã™ã‚‹ edition ã‚’åˆ—æŒ™ï¼‰
// â€»å¤§ä¼šãƒšãƒ¼ã‚¸ã®ã‚°ãƒ«ãƒ¼ãƒ—/çµæœãŒæœªæŠ•å…¥ã§ã‚‚ã€ãƒãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯æˆç«‹ã™ã‚‹
const yearsForCountry = Array.from(
  new Set(
    loadCallups()
      .filter((r: any) => String(r.competition ?? "") === "WC")
      .filter((r: any) => String(r.country ?? "").trim() === countryName)
      .map((r: any) => String(r.edition ?? "").trim())
      .filter(Boolean),
  ),
).sort((a, b) => Number(a) - Number(b));

// ã‚¯ãƒ©ãƒ–ãƒªãƒ³ã‚¯è§£æ±ºï¼ˆclub_master.csv ã‚’ä½¿ã†ï¼‰
const normalize = (s: any) =>
  String(s ?? "")
    .trim()
    .toLowerCase();

// é¸æ‰‹ã”ã¨ã®ã€Œéå»ã«æ‹›é›†ã•ã‚ŒãŸå¤§ä¼šï¼ˆeditionï¼‰ã€ä¸€è¦§ï¼ˆãƒªãƒ³ã‚¯ç”¨ï¼‰
const playerKey = (r: any) =>
  `${normalize(r.name_en || r.name_ja)}|${normalize(r.birth_date)}`;

const all = loadCallups();
const wcAllForCountry = all.filter(
  (r) =>
    String(r.competition ?? "").trim() === "WC" &&
    String(r.country ?? "").trim() === countryName,
);

const editionsByPlayer = new Map<string, string[]>();
for (const r of wcAllForCountry) {
  const k = playerKey(r);
  const ed = String(r.edition ?? "").trim();
  if (!ed) continue;
  const arr = editionsByPlayer.get(k) ?? [];
  if (!arr.includes(ed)) arr.push(ed);
  editionsByPlayer.set(k, arr);
}
// è¡¨ç¤ºã¯é™é †ã«ï¼ˆæ•°å­—ã¨ã—ã¦æ¯”è¼ƒï¼‰
for (const [k, arr] of editionsByPlayer) {
  arr.sort((a, b) => Number(a) - Number(b));
  editionsByPlayer.set(k, arr);
}
const groups = loadGroups("WC", String(year), "group");

// ãã®å›½ã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆgroups.csv ã‹ã‚‰æ¢ã™ï¼‰
const norm = (s: any) =>
  String(s ?? "")
    .trim()
    .replace(/ã€€/g, " ")
    .replace(/\s+/g, " ");

const group =
  groups.find((g: any) => norm(g.route_param) === norm(countryName))?.group ??
  groups.find((g: any) => norm(g.country_name_ja) === norm(countryName))
    ?.group ??
  "";

// ãã®å›½ã®å¤§é™¸ï¼ˆcallupsã®æœ€åˆã®è¡Œã‹ã‚‰å–ã‚Œã‚‹æƒ³å®šï¼‰
const continent = rowsAll[0]?.confederation ?? "";

const rows = rowsAll.sort(sortForRoster);
const starRows = rows
  .filter((r) => String((r as any).is_star ?? "").trim() === "1")
  .slice(0, 3);

const parseAliases = (aliases: string) =>
  String(aliases || "")
    .split(/[|,ã€/]/)
    .map((s) => s.trim())
    .filter(Boolean);

const clubMaster = loadClubMaster();

// club_squads ã®å­˜åœ¨åˆ¤å®šï¼ˆseason + window + league_key + club_keyï¼‰
const clubSquadKeySet = new Set(
  loadClubSquads().map(
    (r) => `${r.season}|||${r.window}|||${r.league_key}|||${r.club_key}`,
  ),
);

// WCã®edition â†’ ã‚¯ãƒ©ãƒ–å´ã® season/window ã¸å¯„ã›ã‚‹
function mapWcToClubSeason(edition: string) {
  const y = Number(String(edition || "").trim());
  if (!Number.isFinite(y) || y < 1900) return null;

  // ä¾‹å¤–ï¼šWC2022ï¼ˆ12æœˆé–‹å‚¬ï¼‰â†’ 2022-23 å¤
  if (y === 2022) return { season: "2022-23", window: "summer" as const };

  // é€šå¸¸ï¼šWCã¯6æœˆï¼ˆã‚·ãƒ¼ã‚ºãƒ³ã‚ªãƒ•ï¼‰â†’ å‰ã‚·ãƒ¼ã‚ºãƒ³å†¬ï¼ˆä¾‹ï¼š2018â†’2017-18ï¼‰
  const prev = y - 1;
  const season = `${prev}-${String(y).slice(2)}`;
  return { season, window: "winter" as const };
}

const clubHref = (clubName: string) => {
  const raw = String(clubName || "").trim();
  if (!raw) return "";

  const key = normalize(raw);

  const c = clubMaster.find((x: any) => {
    const ja = normalize(x.club_display_ja || "");
    const en = normalize(x.club_display_en || "");
    if (key === ja || key === en) return true;

    const als = parseAliases(x.aliases);
    return als.some((a) => normalize(a) === key);
  });

  if (!c) return "";

  // âœ… éå»å¤§ä¼šï¼šè©²å½“seasonã®club_squadsãŒç„¡ã‘ã‚Œã°ãƒªãƒ³ã‚¯ã—ãªã„
  const mapped = mapWcToClubSeason(String(year));
  if (!mapped) return "";

  const squadKey = (season: string, window: "summer" | "winter") =>
    `${season}|||${window}|||${c.league_key}|||${c.club_key}`;

  // ç¬¬ä¸€å¸Œæœ›ï¼šmapWcToClubSeason ã® window
  let win: "summer" | "winter" = mapped.window;

  // ç„¡ã‘ã‚Œã°åå¯¾å´ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (!clubSquadKeySet.has(squadKey(mapped.season, win))) {
    const alt: "summer" | "winter" = win === "summer" ? "winter" : "summer";
    if (clubSquadKeySet.has(squadKey(mapped.season, alt))) {
      win = alt;
    } else {
      return "";
    }
  }

  // âœ… clubãƒšãƒ¼ã‚¸å´ã¯ ?season= &window= ã‚’å—ã‘å–ã£ã¦åˆæœŸè¡¨ç¤ºã‚’åˆ‡æ›¿ã§ãã‚‹
  return `/clubs/${c.league_key}/${c.club_key}?season=${encodeURIComponent(
    mapped.season,
  )}&window=${encodeURIComponent(win)}`;
};

const columns = buildNtColumns({
  isLatestView: true,
  showStats: false,
  clubHref,

  tournamentLinks: (r) => {
    const k = `${normalize(r.name_en || r.name_ja)}|${normalize(r.birth_date)}`;
    const editions = editionsByPlayer.get(k) ?? [];
    return editions.map((ed) => ({
      label: ed,
      href: `/wc/${encodeURIComponent(ed)}/team/${encodeURIComponent(countryName)}`,
    }));
  },
});

const topHref = `/wc/${year}`;

// <title> ç”¨ï¼ˆå…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒšãƒ¼ã‚¸åã«ã‚‚å‡ºã‚‹ï¼‰
const title = `FIFAãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—${year}ï¼ˆWC${year}ï¼‰${countryName}ä»£è¡¨ãƒ¡ãƒ³ãƒãƒ¼`;
const description = `${countryName}ä»£è¡¨ã®æ‹›é›†ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆWC${year} / FIFAãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚«ãƒƒãƒ—${year}ï¼‰ã€‚ãƒã‚¸ã‚·ãƒ§ãƒ³ã€æ‰€å±ã‚¯ãƒ©ãƒ–ã€ä»£è¡¨ãƒ‡ãƒ“ãƒ¥ãƒ¼ã€ç”Ÿå¹´æœˆæ—¥ãªã©ã€‚`;
const heading = `${countryName}ä»£è¡¨`;
---

<BaseLayout
  title={title}
  description={description}
  bodyClass="page-wc"
  bodyStyle="margin:0; font-family: system-ui;"
  showPageHeader={true}
  crumbs={[
    { label: "ãƒˆãƒƒãƒ—", href: "/" },
    { label: `WC${year}`, href: topHref },
    { label: countryName },
  ]}
  heading={heading}
>
  {
    yearsForCountry.length > 1 && (
      <div class="pills nt-year-pills" aria-label="å¤§ä¼šå¹´åˆ‡æ›¿">
        {yearsForCountry.map((y) => (
          <a
            class={`pill ${String(y) === String(year) ? "is-active" : ""}`}
            href={`/wc/${y}/team/${encodeURIComponent(countryName)}`}
          >
            <span class="dot" aria-hidden="true" />
            {y}
          </a>
        ))}
      </div>
    )
  }

  {
    (continent || group) && (
      <div class="nt-nav-pills">
        {continent && (
          <a
            class="pill"
            href={`/wc/${year}?continent=${encodeURIComponent(continent)}#teams`}
          >
            ğŸŒ {continent}
          </a>
        )}
        {group && (
          <a
            class="pill"
            href={`/wc/${year}?group=${encodeURIComponent(group)}#teams`}
          >
            ğŸ”  ã‚°ãƒ«ãƒ¼ãƒ— {group}
          </a>
        )}
      </div>
    )
  }

  {/*  æ›´æ–°æ—¥ï¼ˆæ³¨ç›®é¸æ‰‹ã®ä¸Šã«ç½®ãï¼šçŠ¶æ…‹ â†’ å†…å®¹ã®é †ï¼‰ */}
  <div class="nt-meta-line" aria-label="æ›´æ–°æ—¥">
    æ›´æ–°æ—¥ï¼š
    <span class="updated-date">
      {toYMD(maxSnapshot) || "â€”"}
    </span>
  </div>

  <section class="star-block" aria-label="æ³¨ç›®é¸æ‰‹">
    <h2 class="star-title">â­ æ³¨ç›®é¸æ‰‹</h2>

    {
      starRows.length > 0 ? (
        <div class="star-grid">
          {starRows.map((r) => (
            <div class="star-card">
              <div class="star-name">
                {r.name_ja || r.name_en || r.name}
                <span class="star-pos">
                  ï¼ˆ{r.position_primary || r.position}ï¼‰
                </span>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="star-empty">æº–å‚™ä¸­</div>
      )
    }
  </section>

  <RosterView {rows} {columns} />

  <script is:inline define:vars={{ topHref }}>
    const TOP = topHref;

    function updateBackLink() {
      const a = document.getElementById("back-link-anchor");
      if (!a) return false;

      const params = new URLSearchParams(location.search);
      const from = (params.get("from") || "").trim();
      const anchor = (params.get("anchor") || "").trim();

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      let href = TOP;
      let label = "WCä¸€è¦§ã¸æˆ»ã‚‹";

      // from=group-A
      const mGroup = from.match(/^group-(.+)$/);
      if (mGroup) {
        const g = mGroup[1];
        href = `${TOP}?group=${encodeURIComponent(g)}`;
        label = `ã‚°ãƒ«ãƒ¼ãƒ—${g}ã¸æˆ»ã‚‹`;
      }

      // from=conf-UEFA
      const mConf = from.match(/^conf-(.+)$/);
      if (mConf) {
        const conf = mConf[1];
        href = `${TOP}?continent=${encodeURIComponent(conf)}`;
        label = `${conf}ã¸æˆ»ã‚‹`;
      }

      if (anchor) href = `${href}#${anchor}`;

      a.href = href;
      a.textContent = `â† ${label}`;
      return true;
    }

    function boot() {
      if (updateBackLink()) return;

      let tries = 0;
      const timer = setInterval(() => {
        tries++;
        if (updateBackLink() || tries >= 40) clearInterval(timer);
      }, 50);
    }

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", boot);
    } else {
      boot();
    }
  </script>

  {/* JSã§æ–‡è¨€å·®ã—æ›¿ãˆã‚‚ã‚ã‚‹ã®ã§ global æ¨å¥¨ */}
  <style is:global>
    /* å¹´ãƒ”ãƒ«ï¼ˆä»£è¡¨ãƒšãƒ¼ã‚¸ä¸Šéƒ¨ï¼‰ */
    .nt-year-pills {
      margin: 2px 0 10px;
    }

    .page-wc .back-link {
      margin: 0 0 10px;
      font-size: 13px;
      color: #374151;
    }
    .page-wc .back-link a {
      color: inherit;
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .page-wc .back-link a:hover {
      opacity: 0.85;
    }

    .star-block {
      margin: 12px 0 16px;
      padding: 10px 12px;
      border-radius: 12px;

      background: #ead5f3;
      border: 1px solid rgba(128, 0, 128, 0.18);
    }

    .star-title {
      margin: 0 0 8px;
      font-size: 13px; /* å°‘ã—å°ã•ã */
      font-weight: 650; /* å°‘ã—å¼±ãï¼ˆ700â†’ï¼‰ */
      opacity: 1;
    }

    .star-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(3, 1fr);
    }

    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ */
    @media (max-width: 900px) {
      .star-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ã‚¹ãƒãƒ› */
    @media (max-width: 640px) {
      .star-grid {
        grid-template-columns: 1fr;
      }
    }

    .star-card {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 10px;
      padding: 8px 10px; /* å°‘ã—è–„ã */
      display: flex;
      align-items: center;
    }

    .star-name {
      font-weight: 600; /* 700â†’600 */
      font-size: 13px; /* ã“ã“ã§ç¢ºå®Ÿã«å°ã•ã */
      line-height: 1.35;
      word-break: keep-all;
    }

    .star-pos {
      font-weight: 500;
      font-size: 12px;
      opacity: 0.7;
      margin-left: 4px;
    }

    .star-empty {
      font-size: 13px;
      opacity: 0.65;
      padding: 8px 4px;
    }

    .page-wc .star-section {
      background: #f3e5f5 !important;
      border-color: rgba(0, 0, 0, 0.08) !important;
      opacity: 1;
    }

    /* ===== ä»£è¡¨ãƒšãƒ¼ã‚¸ï¼šå¤§é™¸ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãƒŠãƒ“ ===== */
    .nt-nav-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 4px 0 14px;
    }

    .page-nt h2,
    .page-nt h3.section-title {
      color: var(--theme-color);
    }

    /* ä»£è¡¨å´ï¼šæ›´æ–°æ—¥ï¼ˆæ³¨è¨˜ï¼‰ */
    .nt-meta-line {
      font-size: 12px;
      opacity: 0.78;
      line-height: 1.2;
      margin: 4px 0 8px;
      text-align: right; /* æ³¨è¨˜æ„Ÿï¼å³å¯„ã› */
      white-space: nowrap;
    }

    /* æ—¢ã« SiteHeader.astro ã«ã‚ã‚‹ãªã‚‰ä¸è¦ã ãŒã€ä¿é™ºã§ */
    .updated-date {
      color: #c0392b;
      font-weight: 700;
    }

    /* pillsãƒ–ãƒ­ãƒƒã‚¯ã®ä½™ç™½ã‚’è»½ãè©°ã‚ã‚‹ï¼ˆä»»æ„ï¼‰ */
    .nt-year-pills {
      margin-bottom: 8px;
    }
    .nt-nav-pills {
      margin: 0 0 6px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 640px) {
      .nt-meta-line {
        margin: 3px 0 6px;
        font-size: 12px;
      }
    }
  </style>
</BaseLayout>
